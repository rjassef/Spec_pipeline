
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Spec_pipeline.Line_Fitter.complex_line &#8212; Spec_pipeline 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">Spec_pipeline 0.9.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Spec_pipeline.Line_Fitter.complex_line</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span>  <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="k">import</span> <span class="n">c</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">.multi_line</span> <span class="k">import</span> <span class="n">Multi_Line_fit</span>
<span class="kn">from</span> <span class="nn">.line_class</span> <span class="k">import</span> <span class="n">Line_fit</span>
<span class="kn">from</span> <span class="nn">.MC_errors_general</span> <span class="k">import</span> <span class="n">get_error</span>


<span class="c1">#This will be its own subclass of Line_fit, actually, but will be made from combinations of Multi_Line_fit objects.</span>

<span class="c1">#We will defferiate between broad and narrow emission lines. In this model, all narrow emission lines have the same width and systemic velocity shift, while this can be different for each of the broad emission lines.</span>

<div class="viewcode-block" id="Complex_Line_fit"><a class="viewcode-back" href="../../../Line_Fitter/implemented.html#Spec_pipeline.Complex_Line_fit">[docs]</a><span class="k">class</span> <span class="nc">Complex_Line_fit</span><span class="p">(</span><span class="n">Line_fit</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flexible method to fit emission lines. Lines are defined in the multi_lines.txt file, and can combine many emission lines to be fit at the same time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line_name : string, optional</span>
<span class="sd">        Name of the emission line. Only for user identification.</span>

<span class="sd">    spec : spec object, optional</span>
<span class="sd">        Spec object to be used as the default spectrum to be fit. Highly recommended to be used.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Complex_Line_fit</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xopt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveunit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>    <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dv_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>

    <span class="c1">###</span>

    <span class="c1">#The continuum regions will be the combination of all continuum regions.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuum_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">continuum_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">continuum_regions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span><span class="p">):</span>
            <span class="n">continuum_regions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">continuum_regions</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">continuum_regions</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">continuum_regions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncont_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuum_regions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">line_name</span><span class="p">,</span><span class="n">width_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1">#Setup the emission line.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Multi_Line_fit</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span><span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_spec</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">width_type</span> <span class="o">=</span> <span class="n">width_type</span>

        <span class="c1">#Replace its continuum model with the local one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flam_cont_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flam_cont_model</span>

        <span class="c1">#If broad, FWHM&gt;=1000 km/s. If narrow, FWHM&lt;=1000 km/s</span>
        <span class="k">if</span> <span class="n">width_type</span> <span class="o">==</span> <span class="s1">&#39;broad&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sigma_v_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlines</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span> <span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">width_type</span> <span class="o">==</span> <span class="s1">&#39;narrow&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sigma_v_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlines</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span> <span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sigma_v_0</span> <span class="o">=</span> <span class="mf">300.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>
        <span class="k">elif</span> <span class="n">width_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown emission line type: &quot;</span><span class="p">,</span><span class="n">width_type</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assuming full bounds for line &quot;</span><span class="p">,</span><span class="n">line_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">set_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x_line</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">]</span>
        <span class="n">x_cont</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_line_pars</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cont_pars</span><span class="p">(</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_i_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="n">i_cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_i_cont</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">i_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_i_line</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">i_ban</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_i_ban</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">i_all</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">i_cont</span><span class="p">,</span><span class="n">i_line</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_ban</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">i_all</span> <span class="o">=</span> <span class="n">i_all</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">i_all</span><span class="p">,</span><span class="n">i_ban</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lam_fit</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">lam_rest</span><span class="p">[</span><span class="n">i_all</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">i_all</span>

    <span class="c1">#This function is called to get the indices of wavelengths ranges that should be excised from the any fit. The first obvious regions to be omitted are the atmospheric A-band and B-band absorption lines. Taken from Smette et al. (2015), section 2.</span>
    <span class="k">def</span> <span class="nf">get_i_ban</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="c1">#A-band</span>
        <span class="n">i_banA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_obs</span><span class="o">&gt;=</span><span class="mf">7590.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_obs</span><span class="o">&lt;=</span><span class="mf">7720.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">))</span>
        <span class="c1">#B-band</span>
        <span class="n">i_banB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_obs</span><span class="o">&gt;=</span><span class="mf">6860.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_obs</span><span class="o">&lt;=</span><span class="mf">6950.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">))</span>
        <span class="n">i_ban</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">i_banA</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">i_banB</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">i_ban</span>

    <span class="k">def</span> <span class="nf">meet_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x_line</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">]</span>
        <span class="n">x_cont</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meet_line_constraints</span><span class="p">(</span><span class="n">x_line</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">meet_cont_constraints</span><span class="p">(</span><span class="n">x_cont</span><span class="p">))</span>

    <span class="c1">###</span>

    <span class="k">def</span> <span class="nf">flam_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">chain_output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">chain_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_line</span> <span class="o">=</span> <span class="n">chain_output</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">x_cont</span> <span class="o">=</span> <span class="n">chain_output</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_line</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">]</span>
            <span class="n">x_cont</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_line</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">x_cont</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">flam_model</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flam_cont_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="n">flam_model</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">x_line</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flam_model</span>

    <span class="k">def</span> <span class="nf">set_initial_fit_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="n">x0_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_initial_fit_values</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">x0_cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_initial_fit_values</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0_line</span><span class="p">,</span><span class="n">x0_cont</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npar_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">npar_cont</span>

    <span class="c1">#####</span>
    <span class="c1"># Continuum Model</span>

    <span class="c1">#For now, we define a linear continuum.</span>
    <span class="k">def</span> <span class="nf">flam_cont_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">x_cont</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_par_parser</span><span class="p">(</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">lam</span><span class="o">+</span><span class="n">b</span>

    <span class="k">def</span> <span class="nf">cont_par_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_cont</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x_cont</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">x_cont</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">waveunit</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">x_cont</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">cont_initial_fit_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="n">i_cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_i_cont</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">mean_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">flam</span><span class="p">[</span><span class="n">i_cont</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span><span class="p">)</span>
        <span class="n">mean_lam</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_rest</span><span class="p">[</span><span class="n">i_cont</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveunit</span><span class="p">)</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">mean_cont</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">mean_lam</span><span class="o">.</span><span class="n">value</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">x0_cont</span> <span class="o">=</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span><span class="n">b0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x0_cont</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npar_cont</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">set_cont_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_cont</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_par_parser</span><span class="p">(</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_cont_pars</span><span class="p">(</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1">#This function is called to determine the indices of the spectrum</span>
    <span class="c1">#to be used for fitting the continuum.</span>
    <span class="k">def</span> <span class="nf">get_i_cont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>

        <span class="n">i_cont_use</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncont_reg</span><span class="p">):</span>
            <span class="n">i_cont_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_rest</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">continuum_regions</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">lam_rest</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">continuum_regions</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="p">)</span>
        <span class="n">i_cont_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">i_cont_use</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">i_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i_cont_flat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i_cont</span>

    <span class="k">def</span> <span class="nf">meet_cont_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_cont</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">x_cont</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">waveunit</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x_cont</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="n">cont_fluxes</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__lam_fit</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_fluxes</span><span class="p">[</span><span class="n">cont_fluxes</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">####</span>
    <span class="c1"># Lines Model</span>

    <span class="k">def</span> <span class="nf">flam_line_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">x_line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">x_line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xopt</span>

        <span class="c1">#Note that n_multilines counts the number of Multi_Line_fit objects, but each of those can be composed of more than 1 line.</span>
        <span class="n">j1</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">flam_line_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lam</span><span class="p">)))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#We&#39;ll set it to the width of the first narrow line.</span>
        <span class="n">dv_narrow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">k</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">:</span>
            <span class="n">j0</span><span class="o">=</span><span class="n">j1</span>
            <span class="n">j1</span><span class="o">+=</span><span class="n">line</span><span class="o">.</span><span class="n">npar_line</span>
            <span class="n">x_line_use</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_translator</span><span class="p">(</span><span class="n">x_line</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">):</span>
                <span class="n">dv</span><span class="p">,</span> <span class="n">flam_line</span><span class="p">,</span> <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_parser</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x_line_use</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">width_type</span> <span class="o">==</span> <span class="s2">&quot;narrow&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_v_narrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">sigma_v_narrow</span>
                        <span class="n">dv</span>      <span class="o">=</span> <span class="n">dv_narrow</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="n">sigma_v</span>
                        <span class="n">dv_narrow</span>      <span class="o">=</span> <span class="n">dv</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">line_center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">flam_line_model</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">flam_line</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">dv</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flam_line_model</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lines_initial_fit_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="c1">#For each line declared, get the starting values.</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lines_initial_fit_values</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lines_initial_fit_values</span><span class="p">(</span><span class="n">spec</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">x0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npar_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npar_line</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">:</span>
            <span class="n">npar_line</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">npar_line</span>
        <span class="k">return</span> <span class="n">npar_line</span>

    <span class="k">def</span> <span class="nf">set_line_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_line</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dv_fit</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_fit</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>

        <span class="n">j1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">k</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dv_narrow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">:</span>
            <span class="n">j0</span><span class="o">=</span><span class="n">j1</span>
            <span class="n">j1</span><span class="o">+=</span><span class="n">line</span><span class="o">.</span><span class="n">npar_line</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_line_pars</span><span class="p">(</span><span class="n">x_line</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">])</span>
            <span class="n">x_line_use</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_translator</span><span class="p">(</span><span class="n">x_line</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">):</span>
                <span class="n">dv</span><span class="p">,</span> <span class="n">flam_line</span><span class="p">,</span> <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_parser</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x_line_use</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">width_type</span> <span class="o">==</span> <span class="s2">&quot;narrow&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_v_narrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">sigma_v_narrow</span>
                        <span class="n">dv</span>      <span class="o">=</span> <span class="n">dv_narrow</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="n">sigma_v</span>
                        <span class="n">dv_narrow</span>      <span class="o">=</span> <span class="n">dv</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dv_fit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_fit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">flam_line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_fit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_v</span>
                <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_i_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="n">i_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_i_line</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span><span class="p">):</span>
            <span class="n">i_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">i_all</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_i_line</span><span class="p">(</span><span class="n">spec</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i_all</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">meet_line_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_line</span><span class="p">):</span>
        <span class="n">j1</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dv_narrow</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">):</span>
            <span class="n">j0</span><span class="o">=</span><span class="n">j1</span>
            <span class="n">j1</span><span class="o">+=</span><span class="n">line</span><span class="o">.</span><span class="n">npar_line</span>
            <span class="n">x_line_use</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_translator</span><span class="p">(</span><span class="n">x_line</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">):</span>
                <span class="n">dv</span><span class="p">,</span> <span class="n">flam_line</span><span class="p">,</span> <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_parser</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x_line_use</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">width_type</span> <span class="o">==</span> <span class="s2">&quot;narrow&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigma_v_narrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">sigma_v_narrow</span>
                        <span class="n">dv</span>      <span class="o">=</span> <span class="n">dv_narrow</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sigma_v_narrow</span> <span class="o">=</span> <span class="n">sigma_v</span>
                        <span class="n">dv_narrow</span>      <span class="o">=</span> <span class="n">dv</span>

                <span class="c1">#Do no allow huge shifts on the line centers</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span><span class="o">&gt;</span><span class="n">line</span><span class="o">.</span><span class="n">dv_max</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1">#Do not allow too narrow or too broad emission lines.</span>
                <span class="k">if</span> <span class="n">sigma_v</span><span class="o">&lt;</span><span class="n">line</span><span class="o">.</span><span class="n">sigma_v_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">sigma_v</span><span class="o">&gt;</span><span class="n">line</span><span class="o">.</span><span class="n">sigma_v_max</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1">#Do no allow negative emission lines.</span>
                <span class="k">if</span> <span class="n">flam_line</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">####</span>

    <span class="k">def</span> <span class="nf">parse_chain_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Output</span><span class="p">):</span>

        <span class="n">x_line</span> <span class="o">=</span> <span class="n">Output</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">x_cont</span> <span class="o">=</span> <span class="n">Output</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dv_low</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dv_hig</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_hig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flamunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_low</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_hig</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntot_lines</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vunit</span>

        <span class="n">j1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">):</span>
            <span class="n">j0</span> <span class="o">=</span> <span class="n">j1</span>
            <span class="n">j1</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">npar_line</span>

            <span class="c1">#Set the Chain locally to each line and parse it.</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span><span class="n">j1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_line</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">npar_fit</span><span class="p">)])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">MC_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_chain</span><span class="p">[:,</span><span class="n">indexes</span><span class="p">]</span>
            <span class="n">line</span><span class="o">.</span><span class="n">parse_chain_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MC_chain</span><span class="p">[:,</span><span class="n">indexes</span><span class="p">])</span>

            <span class="c1">#Now, parse the local chain here. Not sure this really needed though, but keeping it for lecgacy with older codes I think.</span>
            <span class="n">x_line_use</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_translator</span><span class="p">(</span><span class="n">x_line</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">):</span>
                <span class="n">dv</span><span class="p">,</span> <span class="n">flam_line</span><span class="p">,</span> <span class="n">sigma_v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">line_par_parser</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x_line_use</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dv_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_hig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_error</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dv_fit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_hig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_error</span><span class="p">(</span><span class="n">flam_line</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">flam_line_fit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_hig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_error</span><span class="p">(</span><span class="n">sigma_v</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">sigma_v_fit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_par_parser</span><span class="p">(</span><span class="n">x_cont</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_hig</span> <span class="o">=</span> <span class="n">get_error</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_hig</span> <span class="o">=</span> <span class="n">get_error</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="k">return</span>


    <span class="c1">#####</span>

    <span class="c1">#Check if fit can be run. If it can be run for each of the lines, it can be run.</span>
    <span class="k">def</span> <span class="nf">can_fit_be_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_multilines</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please add an emission line before running.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">can_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">:</span>
            <span class="n">can_all</span> <span class="o">=</span> <span class="n">can_all</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">can_fit_be_run</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">can_all</span>

    <span class="c1">##########</span>
    <span class="c1"># Plotting</span>
    <span class="c1">##########</span>

    <span class="c1">#Textbox with fit results. We will use one box per emission line, below the spectrum. We have up to three emission lines.</span>
    <span class="k">def</span> <span class="nf">line_legends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">xloc</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="n">yloc</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_line</span><span class="p">):</span>
            <span class="n">line_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">line</span><span class="o">.</span><span class="n">line_name</span><span class="p">)</span>
            <span class="n">lname</span> <span class="o">=</span> <span class="n">line_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lname</span><span class="p">)</span><span class="o">&lt;</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">:</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="p">[</span><span class="n">lname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">nlines</span><span class="p">):</span>
                <span class="n">textbox</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lname</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">textbox</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FWHM = </span><span class="si">{0:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">FWHM_v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">textbox</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">$\Delta v$ = </span><span class="si">{0:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">dv_fit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MC_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">textbox</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SNR = </span><span class="si">{0:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">line_SNR</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">textbox</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">p   = </span><span class="si">{0:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xloc</span><span class="p">,</span> <span class="n">yloc</span><span class="p">,</span> <span class="n">textbox</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
                <span class="n">xloc</span> <span class="o">+=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span>

        <span class="k">return</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2020, Roberto Assef.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 2.4.0. &nbsp;
    Last built 08 Oct 2020. <br/>
  </p>
</footer>
  </body>
</html>